<!-- keep Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ADD this line so the time scale works -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
  // ======= CONFIG =======
  const API_URL = 'https://script.google.com/macros/s/AKfycbxORG7l3D8rBHa3zEe99ZyWjcqV3fgWXmmP1tJKj_mVfUM8wyVNsZPrsIbZ_3upN5vg/exec';
  const APP_KEY = 'b9d1c0b1b0f847e0a7f44c1a93b9b2ab';

  // ...

  function renderChart(rows){
    const c = el('miniChart'); if(!c) return;
    if(chartRef){ chartRef.destroy(); chartRef=null; }

    // âœ… match your sheet headers
    const dateKey = 'activityDate';
    const valueKey = 'timeSpent';

    const points = rows
      .filter(r => r[dateKey] && r[valueKey] !== undefined && r[valueKey] !== '')
      .map(r => ({ x: new Date(r[dateKey]), y: Number(r[valueKey]) }))
      .sort((a,b) => a.x - b.x);

    if(points.length === 0) return;
    chartRef = new Chart(c, {
      type: 'line',
      data: { datasets: [{ label: 'Time Spent', data: points, parsing:false, xAxisID:'x' }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        scales:{ x:{ type:'time', time:{ unit:'day' } }, y:{ beginAtZero:true } }
      }
    });
  }

  async function lookup(){
    el('error').textContent=''; el('status').textContent='Loading...'; el('resultCard').style.display='none';
    const sid = el('sid').value.trim(); if(!sid){ el('status').textContent=''; el('error').textContent='Enter a SID.'; return; }
    try{
      const url = `${API_URL}?key=${encodeURIComponent(APP_KEY)}&sid=${encodeURIComponent(sid)}`;
      // (optional) debug:
      // console.log('GET', url);
      const res = await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status);
      const json = await res.json(); if(!json.ok) throw new Error(json.error||'Unknown error');

      el('status').textContent = `Found ${json.count} row(s) for SID "${sid}".`;
      // if your backend sends aggregates.totalTimeSpent, show it:
      if (json.aggregates && typeof json.aggregates.totalTimeSpent !== 'undefined') {
        el('summary').innerHTML = `<strong>SID:</strong> ${sid} &middot; <strong>Total time:</strong> ${json.aggregates.totalTimeSpent}`;
      } else {
        el('summary').innerHTML = `<strong>SID:</strong> ${sid}`;
      }
      el('tableWrap').innerHTML = buildTable(json.data || []);
      el('resultCard').style.display='block';
      renderChart(json.data || []);
    }catch(e){ el('status').textContent=''; el('error').textContent = e.message || 'Failed to fetch'; }
  }
</script>
